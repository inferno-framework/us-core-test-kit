require_relative '../../../validation_test'

module USCoreTestKit
  module <%= module_name %>
    class <%= class_name %> < Inferno::Test
      include USCoreTestKit::ValidationTest

      id :<%= test_id %>
      title '<%= resource_type %> resources returned during previous tests conform to the <%= profile_name %>'
      description %(
<%= description %>
      )
      <%-
      base_requirement_ids = ['18', '19', '20', '21', '23', '27', '40', '74']
      base_requirement_map = {
            'DiagnosticReportLabValidationTest' => ['356', '357'],
            'ImmunizationValidationTest' => ['391'],
            'MedicationRequestValidationTest' => ['414'],
            'AverageBloodPressureValidationTest' => ['421'],
            'ObservationClinicalResultValidationTest' => ['427'],
            'ProcedureValidationTest' => ['486'],
            'ServiceRequestValidationTest' => ['520']
      }
      v800_base_requirement_ids = ['808', '809', '810', '811']
      v800_requirement_map = {
            'ProcedureValidationTest' => ['856']
      }
        
      namespace = case module_name
      when 'USCoreV610' then 'hl7.fhir.us.core_6.1.0'
      when 'USCoreV700' then 'hl7.fhir.us.core_7.0.0'
      when 'USCoreV800' then 'hl7.fhir.us.core_8.0.0'
      end

      all_ids = base_requirement_ids
      if base_requirement_map[class_name]
        all_ids += base_requirement_map[class_name]
      end

      if module_name == 'USCoreV800'
        all_ids += v800_base_requirement_ids
        if  v800_requirement_map[class_name]
          all_ids += v800_requirement_map[class_name]
        end
      end

      if namespace
        num_spaces = '      verifies_requirements '.length
      -%>
      verifies_requirements <%= 
        all_ids.map.with_index { |id, i| (i > 0 ? ' ' * num_spaces : '') + "'#{namespace}@#{id}'" + (i < all_ids.size - 1 ? ',' : '') }.join("\n") 
      %>
      <%- end -%>
      output :dar_code_found, :dar_extension_found

      def resource_type
        '<%= resource_type %>'
      end

      def scratch_resources
        scratch[:<%= profile_identifier %>_resources] ||= {}
      end

      run do
        perform_validation_test(scratch_resources[:all] || [],
                                '<%= profile_url %>',
                                '<%= profile_version %>',
                                skip_if_empty: <%= skip_if_empty %>)
      end
    end
  end
end
